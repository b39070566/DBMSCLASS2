{% extends "frontstage.html" %}
{% block head %}
{{ super() }}
{% endblock head %}

{% block title %}購物車清單{% endblock title%}

{% block content %}

{% with messages = get_flashed_messages() %}
{% if messages[0] == 'No permission' %}
  
<script language="javascript">
  alert('您沒有使用者的權限喔！');
</script>

{% endif %}
{% endwith %}

<br/>
<div class="container-xl">
  <br/>
  <form method="post" action={{ url_for('bookstore.cart') }}>
    <table class="table table-bordered">
      <tr>
        <th><center>商品編號</center></th>
        <th><center>商品名稱</center></th>
        <th><center>商品價格</center></th>
        <th><center>數量</center></th>
        <th><center>商品操作</center></th>
      </tr>
      {% for book in data %}
      <tr>
        <td> <center>{{ book.商品編號 }}</center></td>
        <td> <center>{{ book.商品名稱 }}</center></td>
        <td> <center>{{ book.商品價格 }}</center></td>
        <td width="20%">
          <center>
            <input class="form-control" type="number" onkeyup="value=value.replace(/[^\d]/g,'')" min="1" value="{{ book.數量 }}" name="{{ book.商品編號 }}">

          </center>
        </td>
        <td>
          <center>
            <button class="btn btn-danger" type="submit" value="{{book.商品編號}}" name="delete" onclick="return (confirm('你確定要刪除 \'{{ book.商品名稱 }}\' 嗎？'))">
              刪除
            </button>
          </center>
        </td>
      </tr>
      {% endfor %}
    </table>
    <center>
      <div class="option">
        <button class="btn btn-primary" type="submit" value="edit" name="user_edit" >繼續購物</button>
        <button class="btn btn-success" type="submit" value="edit" name="buy" >直接結帳</button>
      </div>
    </center>


  </form>

</div>

<div class="container-xl" style="padding-top: 40px;">
    <h2>球隊戰績</h2>
    
    <table id="standings-table">
        <thead>
            <tr>
                <th>排名</th>
                <th>球隊名稱</th>
                <th>勝</th>
                <th>敗</th>
                <th>勝率</th>
                <th>勝差</th>
            </tr>
        </thead>
        <tbody id="standings-body">
            <tr>
                <td colspan="6" style="text-align: center;">戰績載入中...</td>
            </tr>
        </tbody>
    </table>
</div>

<style>
    #standings-table {
        border-collapse: collapse;
        width: 100%; /* 讓表格跟 container 一樣寬 */
        margin: 20px auto;
        font-size: 1em;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    #standings-table thead tr {
        background-color: #005A9C; /* 棒球藍 */
        color: #ffffff;
    }
    #standings-table th,
    #standings-table td {
        padding: 12px 15px;
        border: 1px solid #ddd;
        text-align: left;
    }
    #standings-table td:first-child, /* 排名 */
    #standings-table td:nth-child(n+3) { /* 勝敗勝率勝差 */
        text-align: center;
    }
    #standings-table tbody tr:nth-of-type(even) {
        background-color: #f3f3f3;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // 呼叫我們在 api.py 裡建立的 /api/records API
        fetch('/api/records')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('standings-body');
                tableBody.innerHTML = ''; // 清空 "載入中"

                // 檢查 API 是否回傳錯誤
                if (data.error) {
                    tableBody.innerHTML = `<tr><td colspan="6">載入失敗: ${data.error}</td></tr>`;
                    return;
                }

                // 迴圈處理 API 傳回來的每一筆球隊資料
                data.forEach((team, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${team.team_name}</td>
                        <td>${team.wins}</td>
                        <td>${team.losses}</td>
                        <td>${team.win_rate !== null ? team.win_rate.toFixed(3) : '0.000'}</td>
                        <td>${team.games_behind}</td>
                    `;
                    // 把這一列加到表格中
                    tableBody.appendChild(row);
                });
            })
            .catch(error => {
                // 如果 API 呼叫本身失敗 (例如 404 或 500)
                console.error('Error fetching standings:', error);
                const tableBody = document.getElementById('standings-body');
                tableBody.innerHTML = `<tr><td colspan="6">無法載入戰績資料。</td></tr>`;
            });
    });
</script>

{% endblock content%}